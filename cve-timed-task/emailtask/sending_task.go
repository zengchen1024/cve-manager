package emailtask

import (
	"github.com/opensourceways/cve-manager/cve-timed-task/db_models"
	"github.com/astaxie/beego/logs"
	"github.com/astaxie/beego/orm"
	"io/ioutil"
)

func SendingTypeTwo(filePath string) {
	ormModel := orm.NewOrm()
	result, _, gErr := db_models.GetCveEmailListByEmailType("1", ormModel)
	if gErr != nil {
		logs.Error("db_models.GetCveEmailListByEmailType error:", gErr)
		return
	}

	fList := make([]string, 0, 10)
	fileList, err := ioutil.ReadDir(filePath)
	if err != nil {
		logs.Error("ReadDir error:", filePath, err.Error())
	}

	for _, file := range fileList {
		if file.IsDir() {
			continue
		}
		fileName := file.Name()
		childFilePath := filePath + fileName
		fList = append(fList, childFilePath)
	}

	subject := "Form error data feedback(人工CVE漏洞数据错误反馈)"
	content := "The submitted CVE data is wrong, please check the format and content, please refer to the attachment"

	for _, i := range result {
		err = SendEmail([]string{i.EmailName}, []string{}, subject, content, fList)
		if err != nil {
			logs.Error("SendEmail error:", err)
		}
	}
}
